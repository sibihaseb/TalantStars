<!DOCTYPE html>
<html>
<head>
    <title>Profile Image Upload Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 500px; margin: 0 auto; }
        .upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; margin: 20px 0; }
        .upload-area:hover { border-color: #007bff; }
        .result { margin: 20px 0; padding: 15px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        #imagePreview { max-width: 200px; margin: 10px 0; }
        .progress { margin: 10px 0; }
        .progress-bar { width: 100%; height: 20px; background-color: #e9ecef; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background-color: #007bff; width: 0%; transition: width 0.3s ease; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Profile Image Upload Test</h1>
        
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <p>Click here to select an image file</p>
            <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
        </div>
        
        <div id="selectedFile" class="info" style="display: none;">
            <p><strong>Selected file:</strong> <span id="fileName"></span></p>
            <p><strong>Size:</strong> <span id="fileSize"></span> bytes</p>
            <p><strong>Type:</strong> <span id="fileType"></span></p>
            <img id="imagePreview" style="display: none;" alt="Preview">
        </div>
        
        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">Uploading...</p>
        </div>
        
        <button id="uploadBtn" onclick="uploadImage()" disabled>Upload Image</button>
        <button id="loginBtn" onclick="loginAsAdmin()">Login as Admin</button>
        
        <div id="result" style="display: none;"></div>
        
        <div class="info">
            <h3>Test Instructions:</h3>
            <ol>
                <li>Click "Login as Admin" to authenticate (uses admin credentials)</li>
                <li>Select an image file using the upload area</li>
                <li>Click "Upload Image" to test the upload functionality</li>
                <li>Check the result - it should show success and the Wasabi S3 URL</li>
            </ol>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let isLoggedIn = false;

        // Check if user is logged in
        async function checkLoginStatus() {
            try {
                const response = await fetch('/api/user');
                if (response.ok) {
                    isLoggedIn = true;
                    document.getElementById('loginBtn').textContent = 'Logged In ✓';
                    document.getElementById('loginBtn').disabled = true;
                    showResult('User is logged in', 'success');
                } else {
                    isLoggedIn = false;
                    showResult('Please login first', 'info');
                }
            } catch (error) {
                console.error('Error checking login status:', error);
                showResult('Error checking login status', 'error');
            }
        }

        // Login as admin
        async function loginAsAdmin() {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'TalentStars2024!'
                    })
                });

                if (response.ok) {
                    isLoggedIn = true;
                    document.getElementById('loginBtn').textContent = 'Logged In ✓';
                    document.getElementById('loginBtn').disabled = true;
                    showResult('Successfully logged in as admin', 'success');
                } else {
                    const error = await response.json();
                    showResult('Login failed: ' + error.message, 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showResult('Login error: ' + error.message, 'error');
            }
        }

        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                selectedFile = file;
                
                // Show file details
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = file.size.toLocaleString();
                document.getElementById('fileType').textContent = file.type;
                document.getElementById('selectedFile').style.display = 'block';
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
                
                // Enable upload button if logged in
                if (isLoggedIn) {
                    document.getElementById('uploadBtn').disabled = false;
                }
            } else {
                showResult('Please select a valid image file', 'error');
            }
        }

        // Upload image
        async function uploadImage() {
            if (!selectedFile) {
                showResult('Please select a file first', 'error');
                return;
            }

            if (!isLoggedIn) {
                showResult('Please login first', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('image', selectedFile);

            // Show progress
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('uploadBtn').disabled = true;

            try {
                const response = await fetch('/api/user/profile-image', {
                    method: 'POST',
                    body: formData
                });

                // Hide progress
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('uploadBtn').disabled = false;

                if (response.ok) {
                    const result = await response.json();
                    showResult(`Upload successful! Image URL: ${result.profileImageUrl}`, 'success');
                    console.log('Upload result:', result);
                } else {
                    const error = await response.json();
                    showResult(`Upload failed: ${error.message}`, 'error');
                    console.error('Upload error:', error);
                }
            } catch (error) {
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('uploadBtn').disabled = false;
                console.error('Upload error:', error);
                showResult('Upload error: ' + error.message, 'error');
            }
        }

        // Show result message
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result ' + type;
            resultDiv.textContent = message;
            resultDiv.style.display = 'block';
        }

        // Check login status on page load
        window.onload = checkLoginStatus;
    </script>
</body>
</html>